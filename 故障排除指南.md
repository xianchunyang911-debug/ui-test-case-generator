# 故障排除指南

## 🔧 已修复的问题

### 1. ✅ Module对象序列化问题
**错误**: `'Module' object is not subscriptable`

**原因**: 直接存储Module对象到Session State，导致序列化/反序列化失败

**修复**: 
- 存储时转换为字典：`[module.to_dict() for module in modules]`
- 读取时转换为对象：`[Module.from_dict(m) for m in modules_dict]`

### 2. ✅ 字典访问属性问题
**错误**: `'dict' object has no attribute 'id'`

**原因**: 传递字典给期望Module对象的方法

**修复**: 
- 使用 `SessionStateManager.get_modules()` 统一获取Module对象
- 在文件顶部导入 `SessionStateManager`

### 3. ✅ DataFrame列不存在问题
**错误**: `None of [Index(['用例编号', '页面/模块', '检查点', '优先级'])] are in the [columns]`

**原因**: `all_cases` 为空列表时，DataFrame没有列

**修复**:
- 检查 `all_cases` 是否为空
- 检查列是否存在再访问
- 提供友好的提示信息

### 4. ✅ 文件路径None问题
**错误**: `stat: path should be string, bytes, os.PathLike or integer, not NoneType`

**原因**: `generated_file` 可能为None

**修复**: 
- 使用 `st.session_state.get('generated_file')` 安全获取
- 检查文件路径是否存在再使用

## 🚀 使用前必读

### ⚠️ 重要：首次使用必须清除旧数据

如果你之前使用过旧版本的应用，**必须先清除数据**：

1. 打开 http://localhost:8501
2. 点击右上角 **"🗑️ 清除数据"** 按钮
3. 等待页面刷新
4. 重新开始使用

**为什么要清除？**
- 旧版本存储的是Module对象
- 新版本存储的是字典
- 格式不兼容会导致错误

## 📋 完整使用流程

### 步骤1: 清除旧数据（如果有）
```
点击 "🗑️ 清除数据" → 页面刷新
```

### 步骤2: 上传文档
```
选择文件 → 查看预览 → 确认
```

### 步骤3: 识别模块
```
点击 "🔍 模块/页面识别" → 等待识别 → 查看结果
```

### 步骤4: 选择模块
```
勾选需要的模块 → 使用搜索过滤 → 选择建议选项
```

### 步骤5: 生成用例
```
点击 "🚀 生成UI走查用例" → 等待生成 → 查看结果
```

### 步骤6: 下载结果
```
切换到 "📊 生成结果" → 点击 "📥 下载用例文件"
```

## 🐛 常见错误及解决方案

### 错误1: 识别模块后报错
**症状**: 点击"模块/页面识别"后出现错误

**解决方案**:
1. 点击"清除数据"按钮
2. 刷新浏览器页面（Ctrl+R 或 Cmd+R）
3. 重新上传文档
4. 重新识别

### 错误2: 复选框无法点击
**症状**: 点击复选框没有反应或报错

**解决方案**:
1. 检查浏览器控制台是否有错误
2. 清除浏览器缓存
3. 点击"清除数据"按钮
4. 刷新页面

### 错误3: 生成用例失败
**症状**: 点击生成按钮后报错或无响应

**解决方案**:
1. 检查是否选择了至少一个模块
2. 检查网络连接（如果使用AI模式）
3. 检查API Key是否正确（如果使用AI模式）
4. 尝试使用规则识别模式（不勾选"使用AI生成"）

### 错误4: 下载文件失败
**症状**: 点击下载按钮没有反应

**解决方案**:
1. 检查是否已经生成了用例
2. 检查 `output` 目录是否存在
3. 检查文件权限
4. 重新生成用例

### 错误5: 页面一直加载
**症状**: 页面显示"Running..."一直不结束

**解决方案**:
1. 等待30秒
2. 刷新页面
3. 重启Streamlit应用
4. 检查终端是否有错误信息

## 🔍 调试技巧

### 1. 查看浏览器控制台
```
Chrome/Edge: F12 → Console
Safari: Cmd+Option+C
Firefox: F12 → Console
```

### 2. 查看Streamlit日志
```bash
# 在运行Streamlit的终端查看输出
# 会显示Python错误和警告
```

### 3. 检查Session State
在代码中添加调试信息：
```python
st.write("Debug - Session State Keys:", list(st.session_state.keys()))
st.write("Debug - Modules:", st.session_state.get('modules', []))
```

### 4. 测试基本功能
使用提供的测试文档：
```bash
# 使用 test_document.md 测试基本流程
```

## 🔄 重启应用

如果遇到无法解决的问题，尝试重启应用：

### 方法1: 终端重启
```bash
# 在运行Streamlit的终端按 Ctrl+C
# 然后重新运行
streamlit run streamlit_app.py --server.port 8501
```

### 方法2: 清除缓存重启
```bash
# 停止应用
Ctrl+C

# 清除缓存
rm -rf .streamlit/cache

# 重新启动
streamlit run streamlit_app.py --server.port 8501
```

## 📊 验证修复

运行以下测试验证功能正常：

### 测试1: 模块识别
```bash
python test_module_recognizer.py
```

### 测试2: 模块选择
```bash
python test_module_selector.py
```

### 测试3: 建议选项
```bash
python test_suggested_categories.py
```

### 测试4: 完整流程
```bash
python test_integration.py
```

所有测试应该显示 "✅ 所有测试通过"

## 🆘 获取帮助

如果以上方法都无法解决问题：

1. **查看测试总结**: `TEST_SUMMARY.md`
2. **查看设计文档**: `.kiro/specs/module-selection-feature/design.md`
3. **查看需求文档**: `.kiro/specs/module-selection-feature/requirements.md`
4. **查看使用说明**: `模块选择功能使用说明.md`

## ✅ 验证清单

使用前请确认：

- [ ] 已点击"清除数据"按钮
- [ ] 浏览器已刷新
- [ ] Streamlit应用正在运行（http://localhost:8501）
- [ ] 没有终端错误信息
- [ ] 浏览器控制台没有错误

使用时请确认：

- [ ] 文档已成功上传
- [ ] 模块识别成功
- [ ] 至少选择了一个模块
- [ ] 生成按钮可点击
- [ ] 生成成功并显示结果

## 🎉 成功标志

如果看到以下内容，说明一切正常：

1. ✅ 识别成功！共识别到 X 个模块
2. 📋 模块列表正常显示，复选框可点击
3. 🎯 建议选项可以勾选
4. 🚀 生成按钮可点击
5. ✅ 生成完成！共 X 个用例
6. 📥 可以下载CSV文件
7. 📊 预览显示用例数据

---

**记住**: 遇到问题时，第一步永远是 **"清除数据"** ！
